<!DOCTYPE html>
<!--suppress ALL -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Social map</title>

    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="google-signin-client_id" content="1064250070524-dmfmvjjhi1lfkiaeafk2nm7lifnh5kb6.apps.googleusercontent.com">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.4.0/leaflet.markercluster-src.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.4.0/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css"/>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.4.0/MarkerCluster.Default.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.4.0/MarkerCluster.css"/>
    <link rel="stylesheet"
          href="https://raw.githubusercontent.com/python-visualization/folium/master/folium/templates/leaflet.awesome.rotate.css"/>

    <link href="http://rawgit.com/dimsemenov/PhotoSwipe/master/dist/photoswipe.css" rel="stylesheet">
    <link href="http://rawgit.com/dimsemenov/PhotoSwipe/master/dist/default-skin/default-skin.css" rel="stylesheet">
    <script src="http://rawgit.com/dimsemenov/PhotoSwipe/master/dist/photoswipe.js"></script>
    <script src="http://rawgit.com/dimsemenov/PhotoSwipe/master/dist/photoswipe-ui-default.min.js"></script>

    <script src="http://rawgit.com/iamdustan/smoothscroll/master/dist/smoothscroll.js"></script>
    <script src="http://rawgit.com/jquery/jquery-mousewheel/master/jquery.mousewheel.min.js"></script>

    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>


    <script type="text/javascript">
        isTesting = false;

        testposts = [
            { "topic" : "sea" , "post_url" : "https://www.instagram.com/p/BWdDalLH8V6" , "username" : "petpumprlova" , "user_photo_url" : "https://instagram.fhen1-1.fna.fbcdn.net/t51.2885-19/s150x150/17493461_138283886700602_2983715176395571200_a.jpg" , "lat" : 42.5667 , "long" : 14.1 , "photo_url" : "https://instagram.fhen1-1.fna.fbcdn.net/t51.2885-15/e35/19985431_1770558046567963_1106955317201076224_n.jpg" , "icon_url" : "https://instagram.fhen1-1.fna.fbcdn.net/t51.2885-15/e35/19985431_1770558046567963_1106955317201076224_n.jpg" , "width" : 1080 , "height" : 1302 , "user_url" : "https://www.instagram.com/petpumprlova" , "text" : "Po 7letech jsem nejela letos pracovat do itosky a tak hnusny pocasi tady,tak aspon male pripomenuti- PRIMETIME‚ù§\n#holiday #vacanza #mare #sea #italy #mygirl #frend #sun #primetime #view #like4like #likeforlike #picoftheday üåä‚òÄÔ∏èüáÆüáπ‚ù§üë©‚Äç‚ù§Ô∏è‚Äçüë©" , "network" : "instagram" , "key" : "BWdDalLH8V6" , "topicStatistic" : { "postsCount" : 1 , "usersCount" : 1 , "timeStatistic" : [ "1499878440,1"] , "relatedTopics" : [ "#holiday,1" , "#vacanza,1" , "#mare,1" , "#sea,1" , "#italy,1" , "#mygirl,1" , "#frend,1" , "#sun,1" , "#primetime,1" , "#view,1"]}}
,           { "topic" : "sea" , "post_url" : "https://www.instagram.com/p/BWdDajGBiOd" , "username" : "efpiem" , "user_photo_url" : "https://instagram.fhen1-1.fna.fbcdn.net/t51.2885-19/s150x150/18888741_273608839778546_8156843082147430400_a.jpg" , "lat" : 39.850370737149 , "long" : 18.181885141622 , "photo_url" : "https://instagram.fhen1-1.fna.fbcdn.net/t51.2885-15/e35/19955345_482708402062736_8687410309301796864_n.jpg" , "icon_url" : "https://instagram.fhen1-1.fna.fbcdn.net/t51.2885-15/e35/19955345_482708402062736_8687410309301796864_n.jpg" , "width" : 1080 , "height" : 810 , "user_url" : "https://www.instagram.com/efpiem" , "text" : "Thanks God is Summer #salento #lidomarini #beach #beautiful #italy #italia #summer #clearwater #sea #scuba #dive #sub #nature #seashore #stones #wonderful #paradise #holiday #vacances" , "network" : "instagram" , "key" : "BWdDajGBiOd" , "topicStatistic" : { "postsCount" : 2 , "usersCount" : 1 , "timeStatistic" : [ "1499878440,2"] , "relatedTopics" : [ "#holiday,2" , "#sea,2" , "#italy,2" , "#vacanza,1" , "#mare,1" , "#mygirl,1" , "#frend,1" , "#sun,1" , "#primetime,1" , "#view,1"]}}
,           { "topic" : "sea" , "post_url" : "https://www.instagram.com/p/BWdDadzDh0j" , "username" : "berenisgolty" , "user_photo_url" : "https://instagram.fhen1-1.fna.fbcdn.net/t51.2885-19/s150x150/15253328_1855632091351002_2310746423051681792_a.jpg" , "lat" : 36.843110829823 , "long" : 31.096830126981 , "photo_url" : "https://instagram.fhen1-1.fna.fbcdn.net/t51.2885-15/e15/19933154_825823904259370_6000289438175854592_n.jpg" , "icon_url" : "https://instagram.fhen1-1.fna.fbcdn.net/t51.2885-15/e15/19933154_825823904259370_6000289438175854592_n.jpg" , "width" : 750 , "height" : 750 , "user_url" : "https://www.instagram.com/berenisgolty" , "text" : "–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ –ø—Ä–æ–≤–æ–¥–∏–º –≤—Ä–µ–º—è c @@violettnikitina –≤ @@rixos_premium_belek #instagood #instagram #instacool #cool #amazing #Turkey #sea" , "network" : "instagram" , "key" : "BWdDadzDh0j" , "topicStatistic" : { "postsCount" : 3 , "usersCount" : 1 , "timeStatistic" : [ "1499878440,3"] , "relatedTopics" : [ "#sea,3" , "#holiday,2" , "#italy,2" , "#vacanza,1" , "#mare,1" , "#mygirl,1" , "#frend,1" , "#sun,1" , "#primetime,1" , "#view,1"]}}
,           { "topic" : "sea" , "post_url" : "https://www.instagram.com/p/BWdDaajFgsP" , "username" : "vojtanezdara" , "user_photo_url" : "https://instagram.fhen1-1.fna.fbcdn.net/t51.2885-19/s150x150/14488335_597754150404061_8240013083725004800_a.jpg" , "lat" : 36.8933 , "long" : 27.2889 , "photo_url" : "https://instagram.fhen1-1.fna.fbcdn.net/t51.2885-15/e15/19955212_1889868641274975_8728720172338118656_n.jpg" , "icon_url" : "https://instagram.fhen1-1.fna.fbcdn.net/t51.2885-15/e15/19955212_1889868641274975_8728720172338118656_n.jpg" , "width" : 750 , "height" : 750 , "user_url" : "https://www.instagram.com/vojtanezdara" , "text" : "#kos #greece #vacation #sea #view #sunset #sky" , "network" : "instagram" , "key" : "BWdDaajFgsP" , "topicStatistic" : { "postsCount" : 4 , "usersCount" : 1 , "timeStatistic" : [ "1499878440,4"] , "relatedTopics" : [ "#sea,4" , "#holiday,2" , "#italy,2" , "#view,2" , "#vacanza,1" , "#mare,1" , "#mygirl,1" , "#frend,1" , "#sun,1" , "#primetime,1"]}}
,           { "topic" : "sea" , "post_url" : "https://www.instagram.com/p/BWdDaNNBkkK" , "username" : "vika.kudryashova" , "user_photo_url" : "https://instagram.fhen1-1.fna.fbcdn.net/t51.2885-19/s150x150/17493900_1377617375635602_3077590371073523712_a.jpg" , "lat" : 59.4567795275 , "long" : 28.03200859375 , "photo_url" : "https://instagram.fhen1-1.fna.fbcdn.net/t51.2885-15/e35/19955362_1452451828166253_3157440337161486336_n.jpg" , "icon_url" : "https://instagram.fhen1-1.fna.fbcdn.net/t51.2885-15/e35/19955362_1452451828166253_3157440337161486336_n.jpg" , "width" : 1080 , "height" : 1350 , "user_url" : "https://www.instagram.com/vika.kudryashova" , "text" : "#view #sea #estonia #balticsea #nature #summertime" , "network" : "instagram" , "key" : "BWdDaNNBkkK" , "topicStatistic" : { "postsCount" : 5 , "usersCount" : 1 , "timeStatistic" : [ "1499878440,5"] , "relatedTopics" : [ "#sea,5" , "#view,3" , "#holiday,2" , "#italy,2" , "#nature,2" , "#vacanza,1" , "#mare,1" , "#mygirl,1" , "#frend,1" , "#sun,1"]}}

        ]


    </script>

    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        footer {
            position: fixed;
            height: 100px;
            margin-top: 1em;
            bottom: 0;
            right: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0);
            z-index: 200
        }

        ::-webkit-scrollbar {
            display: none;
        }

        p {
            top: 100px;
            text-align: center;
        }

        #map {
            flex-grow: 1;
            z-index: 10;
            width: 100.0%;
            height: 100.0%;
            left: 0.0%;
            top: 0.0%;
        }


        #scroller-wrapper {
            width: 100%;
            height: 200px;
        }

        #scroller {
            height: 100%;
            overflow-x: auto;
            white-space: nowrap;
        }

        .elem {
            height: 100%;
            width: 100px;
            display: inline-block;
        }

        #scroller-wrapper img {
            position: relative;
            float: left;
            width: 100px;
            height: 100px;
            background-position: 50% 50%;
            background-repeat: no-repeat;
            background-size: cover;
        }


</style>
    <style>
         .pswp__bg{
             filter: blur(10px);
             background-size: cover;
             width: 110%;
             height: 110%;
             left: -15px;
             right: -15px;
             top: -15px;
             bottom: -15px;
             opacity: 1;
             background-position:center;
         }

        .pswp--zoom-allowed .pswp__img {
            cursor: default !important
        }
         .pswp__caption, .pswp__top-bar {
             background-color: rgba(0, 0, 0, 0);
         }
         .pswp__ui--fit .pswp__top-bar, .pswp__ui--fit .pswp__caption {
             background-color: rgba(0, 0, 0, 0);
         }

         .pswp__caption{
            max-height: 30%;
        }

        .pswp__caption__center {
            text-align: center;
            max-height: 50%;
            max-width: 100%;
            font-size: 140%
        }

        #pswp-preview-img-a {
            position: absolute;
            padding: 3px;
            z-index: 9999;
            font-size: 140%

        }
        #pswp-preview-text-a {
            position: absolute;
            margin-left: 45px;
            z-index: 9999;
            color: #fff;
            font-size: 120%

        }


    </style>
    <style>
        .overlay {
            height: 0%;
            width: 100%;
            position: fixed;
            z-index: 1;
            top: 0;
            left: 0;
            background-color: rgba(0,0,0, 0.8);
            overflow-y: hidden;
            transition: 0.5s;
        }

        .overlay-content {
            position: relative;
            top: 25%;
            width: 100%;
            text-align: center;
            margin-top: 30px;
        }

        .overlay a {
            padding: 8px;
            text-decoration: none;
            font-size: 36px;
            color: #818181;
            display: block;
            transition: 0.3s;
        }

        .overlay a:hover, .overlay a:focus {
            color: #f1f1f1;
        }

        .overlay .closebtn {
            position: relative;
            /*top: 20px;*/
            /*right: 45px;*/
            /*font-size: 60px;*/
        }

        @@media screen and (max-height: 450px) {
        .overlay {overflow-y: auto;}
        .overlay a {font-size: 20px}
        .overlay .closebtn {
            font-size: 40px;
            top: 15px;
            right: 35px;
        }
        }

        .menu-button {
            font-size: 25px;
            cursor: pointer;
            z-index: 100;
            position: absolute;
            color: #fff;
        }

    </style>
    <style>
        /* Include the padding and border in an element's total width and height */
        * {
            box-sizing: border-box;
        }

        /* Remove margins and padding from the list */
        ul {
            margin: 0;
            padding: 0;
        }

        /* Style the list items */
        ul li {
            list-style-type: none;
            cursor: pointer;
            position: relative;
            padding: 12px 8px 12px;
            background: #eee;
            font-size: 18px;
            transition: 0.2s;
            text-align: center;


            /* make the list items unselectable */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Set all odd list items to a different color (zebra-stripes) */
        ul li:nth-child(odd) {
            background: #f9f9f9;
        }

        /* Darker background-color on hover */
        ul li:hover {
            /*background: #ddd;*/
        }

        /* When clicked on, add a background color and strike out text */
        ul li.checked {
            background: #888;
            /*color: #fff;*/
            text-decoration: line-through;
        }

        /* Add a "checked" mark when clicked on */
        ul li.checked::before {
            content: '';
            position: absolute;
            /*border-color: #fff;*/
            border-style: solid;
            border-width: 0 2px 2px 0;
            top: 10px;
            left: 16px;
            transform: rotate(45deg);
            height: 15px;
            width: 7px;
        }

        /* Style the close button */
        .close {
            position: absolute;
            right: 0;
            top: 0;
            padding: 12px 16px 12px 16px;
        }

        .close:hover {
            /*background-color: #f44336;*/
            /*color: white;*/
        }

        /* Style the header */
        .header {
            /*background-color: #f44336;*/
            padding: 30px 40px;
            /*color: white;*/
            text-align: center;
        }

        /* Clear floats after the header */
        .header:after {
            content: "";
            display: table;
            clear: both;
        }

        /* Style the input */
        input {
            border: none;
            width: 75%;
            padding: 10px;
            float: left;
            font-size: 16px;
            color: black ;
        }
        elem {
            text-align: center;
        }

        /* Style the "Add" button */
        .addBtn {
            padding: 10px;
            width: 25%;
            background: #d9d9d9;
            color: #555;
            float: left;
            text-align: center;
            font-size: 16px;
            cursor: pointer;
            transition: 0.3s;
        }

        .removeBtn {
            background: #d9d9d9;
            border: none;
            color: #555;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            height: 60%;
        }
    </style>

    <script>
        function generateColor() {
            return "#"+((1<<24)*Math.random()|0).toString(16);
        }

        topicColors = new Map();

    </script>
    <script>
        topics = [];
        topicsStats = new Map();


        function calcRelatedTopics(post, topicStat) {
            if(post.text == null) return;

            var hashtags = post.text.match(/#([^#]+)[\s,;]*/g);
            if(hashtags == null) return;

            hashtags.forEach(h => {
                h = h.trim()
                var maybeRelatedTopic = topicStat.relatedTopics.find(rt => rt.label == h);
                if(maybeRelatedTopic == null) topicStat.relatedTopics.push({label: h, y: 1});
                else maybeRelatedTopic.y += 1;
            })

            topicStat.relatedTopics = topicStat.relatedTopics.sort((b,a) => a.y - b.y)
            var x = 0;
            topicStat.relatedTopics.forEach(rt => {
                rt.x = x;
                x++;
            });
        }

        function calcSpeedStatistic(post, topicStat) {
            var nowtime = ((Date.now() / 1000 | 0) / 60 | 0) * 60;
            nowtime = new Date(nowtime * 1000)

            var maybeCount = topicStat.speedData.find(sd => sd.x.getTime() == nowtime.getTime());
            if(maybeCount == null) topicStat.speedData.push({x: nowtime, y: 1});
            else maybeCount.y += 1;
        }

        function calcStats(post) {
            if(!topicsStats.has(post.topic)) {
                var rt = [];
                var speed = [];

                topicsStats.set(post.topic, {
                    postsCount: 0,
                    usersCount: 0,
                    relatedTopics: rt,
                    topicsChart: new CanvasJS.Chart("relatedTopicsChartContainer-" + post.topic, {
                        theme: "theme1",//theme1
                        title: {
                            text: "Top 20 related topics"
                        },
                        animationEnabled: false,   // change to true
                        dataPointMaxWidth: 20,
                        axisX:{
                            maximum: 20,
                        },
                        axisY: {
                            title: "Posts count"
                        },
                        data: [
                            {
                                // Change type to "bar", "area", "spline", "pie",etc.
                                type: "column",
                                dataPoints: rt
                            }
                        ]

                    }),
                    speedData: speed,
                    speedChart: new CanvasJS.Chart("topicSpeedChartContainer-" + post.topic, {
                        title :{
                            text: "Speed, posts per minute"
                        },
                        axisY: {
                            title: "Posts count"
                        },
                        data: [{
                            type: "line",
                            dataPoints: speed
                        }]
                    })
                });
                return;
            }

            var topicStat = topicsStats.get(post.topic);
            topicStat.postsCount += 1;

            calcRelatedTopics(post,topicStat);
            calcSpeedStatistic(post,topicStat);

            changePostsCountStats(post.topic, topicStat.postsCount);
            changeUsersCountStats(post.topic, post.topicStatistic.usersCount);
            changeRelatedTopicsStats(topicStat);
            changeSpeedStats(topicStat);

        }


        function changePostsCountStats(topic, newval) {
            $("#postsCount-" + topic).html('<h3>Posts count: ' + newval+' <h3> ');
        }
        function changeUsersCountStats(topic, newval) {
            $("#usersCount-" + topic).html('<h3> Watching users count: ' + newval+' <h3> ');
        }
        function changeRelatedTopicsStats(topicStat) {
            topicStat.topicsChart.render();
        }
        function changeSpeedStats(topicStat) {
            avg = 0;
            topicStat.speedData.forEach(sd => {
                avg += sd.y;
            })

            avg = avg / topicStat.speedData.length

//            topicStat.speedChart.title.text = "Speed, posts per minute. average: " + avg;

            topicStat.speedChart.render();
        }

        function addStatisticDivs(topic) {
            if(!topics.includes(topic)) return;

            $("#statsDiv").append('<div id="stats-'+topic+'">' +
                        '<button class="accordion" id="accordion-button-'+topic+'" style="text-align: center; background: '+topicColors.get(topic)+'">'+ topic+'</button>'+
                        '<div class="panel">'+
                            '<div id="postsCount-' + topic + '"></div>' +
                            '<div id="usersCount-' + topic + '"></div>' +
                            '<div id="relatedTopics-' + topic + '"></div>' +
                            '<div id="timeStats-' + topic + '"></div>' +
                            '<div id="relatedTopicsChartContainer-' + topic + '" style="height: 300px; width: 100%;"></div>' +
                            '<div id="topicSpeedChartContainer-' + topic + '" style="height: 300px; width: 100%;"></div>' +


                    '</div>'+
                    '</div>');

            document.getElementById("accordion-button-" + topic).onclick = function() {
                console.log("onclick accordion-button-" + topic);
                this.classList.toggle("active");
                var panel = this.nextElementSibling;
                if (panel.style.maxHeight){
                    panel.style.maxHeight = null;
                } else {
                    panel.style.maxHeight = panel.scrollHeight + "px";
                }
            }

            fakepost = {topic: topic};
            calcStats(fakepost);

        }

        function removeStatisticDivs(topic) {
            document.getElementById("stats-" + topic).remove();
        }


        function onTopicAdded(topic) {
            if(topics.includes(topic)) return;

            topics.push(topic);
            console.log("added topic: " + topic);
            if(!isTesting) socket.send("addTopic:" + topic);

            addStatisticDivs(topic)
        }
        function onTopicRemoved(topic) {
            topics.splice(topics.indexOf(topic),1);
            console.log("removed topic: " + topic);
            if(!isTesting) socket.send("removeTopic:" + topic)

            removeStatisticDivs(topic)
        }
    </script>
    <script>
        ispswpOpen = false;
        items = [];

        var openPhotoSwipe = function (post) {
            var pswpElement = document.querySelectorAll('.pswp')[0];
            $("#pswp-preview-img").attr("src", post.user_photo_url);
            $("#pswp-preview-img-a").attr("href", post.user_url);
            $("#pswp-preview-text-a").html( post.username + " <br> " + post.network + ' topic:' + post.topic);
            $("#pswp-preview-text-a").attr("href", post.user_url);


            $(".pswp__bg").css({"background-image": "url("+post.photo_url+ ")"});


            var options = {
                history: false,
                focus: false,
                showAnimationDuration: 0,
                hideAnimationDuration: 0,
                maxSpreadZoom: 1,
                zoomEl: false
            };

            if(ispswpOpen) {
                return;
            }


            pswp = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, options);
            pswp.init();
            console.log('open');
            ispswpOpen = true;

            pswp.listen('close', function() {
                ispswpOpen = false;
                console.log('close');
            });
            pswp.listen('beforeChange', function(index) {
                var nextitem = items[pswp.getCurrentIndex()];
                $("#pswp-preview-img").attr("src", nextitem.post.user_photo_url);
                $("#pswp-preview-img-a").attr("href", nextitem.post.user_url);
                $("#pswp-preview-text-a").html( nextitem.post.username + " <br> " + nextitem.post.network + ' topic:' + nextitem.post.topic);
                $("#pswp-preview-text-a").attr("href", nextitem.post.user_url);
                $(".pswp__bg").css({"background-image": "url(" +nextitem.post.photo_url+ ")"});
            });

            pswp.goTo(post.index)
        };

    </script>
</head>
<body>


<div id="mySidenav" class="overlay" style="z-index: 1000">

    <div id="myDIV" class="header">

        <div>
            <h2 style="color: #CCC">Welcome to realtime photo map!</h2>
            <h2 style="color: #CCC">Instagram, Vk</h2>
            <h2 style="color: #CCC">You can add topics or hashtags here</h2>
            <input type="text" id="myInput" placeholder="example: spb">
            <span onclick="newTag()" class="addBtn">Add</span>
        </div>
        <br><br><br>
        <ul id="myUL" class="topics"></ul>
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav('mySidenav')">Go to map</a>


        <div style="margin-top: 10px">
            <span onclick="removeAll()" class="removeBtn">Remove all</span>
            <span onclick="removeAllPost()" class="removeBtn">Remove all from map</span>
            <span onclick="removeAllPostFromScroll()" class="removeBtn">Remove all from scroll</span>
        </div>
    </div>
</div>

<div id="statsSidenav" class="overlay" style="z-index: 1000;text-align: center; overflow:scroll">
    <a href="javascript:void(0)" class="closebtn" onclick="closeNav('statsSidenav')">&times;</a>

    <div id="statsDiv">
        <h2 style="color: #CCC; margin-top: 60px;">Statistic by topics</h2>
    </div>
</div>


<span id="topics-menu-button" class="menu-button" onclick="openNav('mySidenav')"    style="position: absolute;left:1%"> &#9776; </span>
<span id="stats-menu-button"  class="menu-button" onclick="openNav('statsSidenav')" style="position: absolute;right:1%"> &#9776; </span>

<script>
    function openNav(what) {
        document.getElementById(what).style.height = "100%";
    }

    function closeNav(what) {
        document.getElementById(what).style.height = "0";
    }
</script>
<script>
    // Create a new list item when clicking on the "Add" button
    function newTag() {

        var li = document.createElement("li");
        var inputValue = document.getElementById("myInput").value;
        if(isTesting) inputValue = "sea";

        var t = document.createTextNode(inputValue);
        li.appendChild(t);


        if (inputValue === '') {
            alert("You must write something!");
        }if (topics.includes(inputValue)) {
            alert("You must write something!");
        } else {

            li.className = inputValue;
            var color = generateColor();
            li.style.backgroundColor = color;
            topicColors.set(inputValue, color);

            document.getElementById("myUL").appendChild(li);
            document.getElementById("myInput").value = "";

            var span = document.createElement("SPAN");
            var txt = document.createTextNode("\u00D7");
            span.className = "close";
            span.appendChild(txt);
            span.onclick = function() {
                var div = this.parentElement;
                div.remove();
                onTopicRemoved(inputValue);
            };
            li.appendChild(span);

            onTopicAdded(inputValue);
        }
    }

    document.getElementById('myInput').onkeypress = function(e){
        if (!e) e = window.event;
        var keyCode = e.keyCode || e.which;
        if (keyCode == '13'){
            newTag();
            return false;
        }
    };

</script>

<style>
    button.accordion {
        background-color: #eee;
        color: #444;
        cursor: pointer;
        padding: 18px;
        width: 100%;
        border: none;
        text-align: left;
        outline: none;
        font-size: 15px;
        transition: 0.4s;
    }

    button.accordion.active, button.accordion:hover {
        background-color: #ddd;
    }

    div.panel {
        padding: 0 18px;
        background-color: white;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.2s ease-out;
    }
</style>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
It's a separate element, as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. PhotoSwipe keeps only 3 slides in DOM to save memory. -->
        <div class="pswp__container">
            <!-- don't modify these 3 pswp__item elements, data is added later on -->
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter" style="visibility: hidden"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <a id="pswp-preview-img-a"  target=_blank><img id="pswp-preview-img" width="40" height="40" ></a>
                <a id="pswp-preview-text-a" target=_blank></a>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<div id="map"></div>

<footer>
    <div id="scroller-wrapper">
        <div id="scroller"></div>
    </div>
</footer>

<script>

    var southWest = L.latLng(-90, -180);
    var northEast = L.latLng(90, 180);
    var bounds = L.latLngBounds(southWest, northEast);

    var map = L.map('map', {
        center: [59.943082, 30.296922],
        zoom: 3,
        maxBounds: bounds,
        layers: [],
        crs: L.CRS.EPSG3857,
        zoomControl: false,
        attributionControl: true
    });

    L.tileLayer('http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
        subdomains: 'abcd',
        maxZoom: 19,
        attribution: '&copy; <a href="http://vk.com/max___petrov">Max Petrov</a>'
    }).addTo(map);


    function locate(lat, long) {
        map.panTo(new L.LatLng(lat, long));
    }

    function markerOnClick(marker) {
        openPhotoSwipe(marker.target.options.data)
    }

    var postsQueue = [];

    function addPostToMap(post) {
        var marker = L.marker([parseFloat(post.lat), parseFloat(post.long)], {
            icon: new L.Icon.Default(),
            data: post
        }).on('click', markerOnClick).addTo(map);
        var markerContent = '<img width=40 height=40 src=' + post.icon_url + '>';
        marker.setIcon(L.divIcon({html: markerContent}));
        postsQueue.push(marker);
        console.log("postsQueue.length = " + postsQueue.length);
        return marker;
    }

    function removeOldPost() {
        if (postsQueue.length >= 50) {
            var m = postsQueue.shift();
            map.removeLayer(m);
        }
    }

    function removeAll() {
        removeAllPost();
        removeAllPostFromScroll();
    }
    function removeAllPost() {
        Array.from(postsQueue).forEach(m => map.removeLayer(m));
    }
    function removeAllPostFromScroll() {
        items = [];
        pswp.close();
        postsCount = 0;
        Array.from(document.getElementsByClassName("elem")).forEach(el=> el.remove());
    }

    var imgCount = 1;
    var isHorizontalScroll = true;

    $("#scroller").mouseover(function () { isHorizontalScroll = false; });
    $("#scroller").mouseout(function () { isHorizontalScroll = true; });
    $("#scroller").mousewheel(function(evt, chg) {
        var isMac = navigator.platform.toUpperCase().indexOf('MAC')>=0;
        if(!isMac){
            this.scrollLeft -= (chg * 50 );
            evt.preventDefault();
        }
    });


    function wrongTopic(topic) {
        console.log("wrongTopic:" + topic);
        Array.from(document.getElementsByClassName(topic)).forEach(el=> el.remove());
        removeStatisticDivs(topic);
        alert("Something wrong with topic " + topic);
    }

    postsCount = 0;
    function handlePost(post) {
        lastpost = post;
        post.index =  postsCount;
        postsCount += 1;
        items.push({
            src: post.photo_url,
            w: post.width,
            h: post.height,
            title: '<a href=' + post.post_url + ' target=_blank style="color: #fff; overflow-y: scroll;">' + post.text + '</a>' + '<br>',
            post: post
        });


        try {
            addPostToMap(post);
            removeOldPost();
        } catch (err) { }

        $("#scroller").append('<div class="elem" id="img' + imgCount + '">' +
                '<img src=' + post.photo_url + ' style="border-bottom:solid ' + topicColors.get(post.topic) + ' 5px">' +
            '</div>');

        if(post.hasOwnProperty("lat")) {
            $("#img" + imgCount).click(function () {
                locate(post.lat, post.long);
            });
        }
        $("#img" + imgCount).dblclick(function() {

            openPhotoSwipe(post);
        });

        if (isHorizontalScroll) {
            document.getElementById('img' + imgCount).scrollIntoView({
                block: "start",
                behavior: "smooth"
            });
        }
        imgCount += 1;

        calcStats(post)
    }

    // for testing only
    if(isTesting){
        setInterval(function () {
            handlePost(testposts[Math.floor(Math.random() * testposts.length)])
        }, 2000);

        newTag()
    }
    else {
        window.onload = function () {
            socket = null;
            isopen = false;

           // socket = new WebSocket("ws://localhost:9000/ws");
            socket = new WebSocket("ws://@util.Util.getServerIp():9000/ws");
            socket.binaryType = "arraybuffer";
            socket.onopen = function () {
                console.log("Connected to websocket!");
                isopen = true;
            };

            socket.onmessage = function (e) {
                if (typeof e.data === "string") {
                    var data = JSON.parse(e.data);
                    console.log("e.data = ",e.data);

                    if(data.hasOwnProperty("wrongTopic")){
                        wrongTopic(data.wrongTopic)
                    }
                    else {
                        handlePost(data)
                    }
                }
            };

            socket.onclose = function (e) {
                console.log("Connection closed.");
                location.reload();
            };

            openNav('mySidenav')
        };
    }

</script>

</body>
</html>
